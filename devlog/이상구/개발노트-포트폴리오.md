# 포트폴리오 기능 개발 과정

## 개요

포트폴리오는 작가의 개인 기록물을 Taptoon 사이트 내에 저장할 수 있는 기능이다.
- 최대 5개까지 생성 가능하고, 각 포트폴리오를 제목으로 구분할 수 있다.
- 최대 3,000자의 내용 입력 가능하다.
- **글 작가**와 **그림 작가** 모두를 고려하여 이미지 파일과 텍스트 파일 저장 지원한다.

---

## 📌 목차
1. [설계 과정](#설계-과정)
    - [초기 설계](#초기-설계)

2. [포트폴리오 기능 상세](#포트폴리오-기능-상세)
    - [포트폴리오 시작하기 (빈 포트폴리오 생성)](#1-포트폴리오-시작하기-빈-포트폴리오-생성)
    - [포트폴리오 내용 채우기 (제목, 내용, 파일)](#2-포트폴리오-내용-채우기-제목-내용-파일)
    - [포트폴리오 수정하기](#3-포트폴리오-수정하기)
    - [포트폴리오 조회하기](#4-포트폴리오-조회하기)
    - [포트폴리오 삭제하기](#5-포트폴리오-삭제하기)

3. [트러블슈팅 (Troubleshooting)](#트러블슈팅-troubleshooting)
    - [포트폴리오 수정 시 이미지 중복 등록 및 삭제 문제](#1-포트폴리오-수정-시-이미지가-중복-등록되거나-삭제되지-않는-문제)
    - [최대 개수 설정 문제](#2-최대-개수-설정)
---

## 설계 과정

### 초기 설계
- 이미지 파일만 업로드하고, 텍스트는 `content` 필드에 저장하는 방식으로 설계되었다.
- 하지만 텍스트 파일도 업로드할 수 있도록 변경되었다. (시나리오 저장 고려)
- 포트폴리오 저장 구조를 이미지 & 텍스트 파일을 모두 허용하도록 수정하였다.

---

## 포트폴리오 기능 상세

### 1. 포트폴리오 시작하기 (빈 포트폴리오 생성)
**초기 설계 변경**  
처음에는 포트폴리오 생성과 동시에 모든 내용을 입력하는 방식이었지만,  
프론트엔드 UX/UI를 고려하여 빈 포트폴리오를 먼저 생성하고, 이후 내용을 채우도록 변경하였다.

**변경 내용**
- 사용자가 "포트폴리오 만들기" 버튼 클릭 시 빈 포트폴리오를 먼저 생성
- 이후 "제목, 내용, 파일"을 채워넣고 최종 저장

**API 동작 흐름**
1. `POST /portfolios` → 빈 포트폴리오 생성
2. `PUT /portfolios/{id}` → 제목, 내용, 파일 추가 및 수정

---

### 2. 포트폴리오 내용 채우기 (제목, 내용, 파일)
**파일 업로드 방식: AWS S3 Presigned URL 사용**
- 플랫폼 특성상 이미지가 중요한 요소이므로 Presigned URL 방식을 채택하였다.
- 초반에는 해당 방식의 동작을 이해하는 데 시간이 걸렸다.

**파일 상태 관리 (3가지 상태 적용)**

| 상태 | 설명                                             |
|------|------------------------------------------------|
| `PENDING` | 사용자가 파일을 첨부했지만 아직 저장하지 않은 상태                   |
| `REGISTERED` | 사용자가 "등록하기" 또는 "완료" 버튼을 누르면 등록되는 상태            |
| `DELETING` | 사용자가 첨부한 파일을 삭제할 경우 해당 상태로 변경 (Soft Delete 적용) |

---

### 3. 포트폴리오 수정하기
**수정 가능한 요소**
- 제목과 내용을 수정할 수 있음
- 미리 첨부된 파일을 추가 및 삭제 가능 (삭제 시 `deleting` 상태 적용하여 Soft Delete)

**고아 객체 문제 해결**
**문제 발생:**  
사용자가 파일을 첨부한 후 "완료" 버튼을 누르지 않고 브라우저를 닫거나 뒤로 가기를 누를 경우,  
고아 객체가 발생하여 첨부된 파일이 `PENDING` 상태로 남아 있게 됨.

**해결 방법:**
- `PENDING` 상태에서 일정 시간 동안 변경되지 않은 파일을 자동 삭제하는 스케줄러 추가

---

### 4. 포트폴리오 조회하기
**전체 조회 (`GET /portfolios`)**
- 사용자가 작성한 모든 포트폴리오를 조회할 수 있음
- 최소한의 정보만 제공 (썸네일 이미지, 제목, 날짜)

**개별 조회 (`GET /portfolios/{id}`)**
- 사용자가 특정 포트폴리오를 선택하면 모든 내용을 확인할 수 있음

---

### 5. 포트폴리오 삭제하기
**포트폴리오 삭제 (`DELETE /portfolios/{id}`)**
- Soft Delete 적용 (isDeleted = true)
- 첨부된 파일은 완전히 삭제 (AWS S3 및 DB에서 삭제)

**설계 의도 변경**
- 실제 서비스에서는 Soft Delete 후 일정 기간 보관하는 것이 일반적이지만,
- 현재는 저장 공간 문제로 인해 완전 삭제 방식을 채택함.

---

## 트러블슈팅 (Troubleshooting)

### 1. 포트폴리오 수정 시 이미지가 중복 등록되거나 삭제되지 않는 문제
**문제 상황**   

사용자가 포트폴리오를 수정하는 과정에서 기존 이미지를 유지하면서 새 이미지가 추가되어야 하지만 
파일이 중복 저장되거나 기존 파일이 사라지는 문제가 발생되었다.

**원인 분석**   

수정 API를 실행하면 새로운 request값을 받게 되면서 위와 같은 문제가 발생되었다.


**해결 방법**

기존에 있었던 파일과 새로 추가되는 파일을 구분하여 처리하는 작업이 필요했다.

**기존 코드**
```java
// 이미지 파일 등록 및 수정 메서드
// 요청된 파일(pending) 모두 찾기
List<PortfolioImage> foundFiles = portfolioImageRepository.findAllById(portfolioRequest.fileIds()).stream()
                .collect(Collectors.toList());

// pending에서 registered로 상태 변환
foundFiles.forEach(PortfolioImage::updateStatus);
```


**개선된 코드**
```java
// 이미지 파일 등록 및 수정 메서드
// 요청된 파일(pending) 모두 찾기
List<PortfolioImage> foundFiles = portfolioImageRepository.findAllById(portfolioRequest.fileIds()).stream()
        .filter(file -> file.getStatus() == Status.PENDING) // Pending 상태인 파일만 처리 (중복 방지)
        .collect(Collectors.toList());

// pending에서 registered로 상태 변환
foundFiles.forEach(PortfolioImage::updateStatus);
```
**결과**

해결 과정은 걱정했던 것보다는 의외로 간단했다. stream에서 filter를 적용시켜 파일을 구분시켜주었는데
기존에 있었던 파일은 `REGISTERED` 상태이고 새로 추가될 파일은 항상 `PENDING` 상태이기 때문에
위 코드처럼 수정 API에서는 `PENDING` 상태의 파일들만 처리되게 해주었다.

---

## 2. 최대 개수 설정

해당 문제는 크게 치명적인 문제는 아니지만, 쉽게 헷갈릴 수 있는 부분이기 때문에 트러블슈팅에 간단히 추가해보려고 한다.

 **문제 상황**
포트폴리오 생성 시 **최대 개수를 5개로 제한**하려고 했다.  
그래서 다음과 같은 코드를 작성했다.

```java
// 포트폴리오는 최대 5개까지 생성 가능
if (countPortfolio > 5) {
    throw new CreationLimitExceededException(ErrorCode.CREATION_LIMIT_EXCEEDED);
}
```
하지만 위와 같이 작성하면 실제로는 6개까지 생성되게 된다.

 **원인 분석**
- `countPortfolio > 5`의 의미는 **포트폴리오 개수가 5개보다 많을 때** 예외가 발생하는 것이다.
- 즉, 포트폴리오 개수가 **5개일 때는 예외가 발생하지 않는다**.
- 따라서 사용자가 5개까지 생성한 후 **6번째 포트폴리오를 생성할 때 예외가 발생**하게 된다.
- **결과적으로 6개까지 생성이 가능**한 문제가 발생된 것이다.

 **해결 방법**
해당 문제를 해결하기 위해 조건을 수정하였다.

```java
// 포트폴리오는 최대 5개까지 생성 가능
if (5 <= countPortfolio) {
    throw new CreationLimitExceededException(ErrorCode.CREATION_LIMIT_EXCEEDED);
}
```
 **결론**

코딩 경험이 많은 사람이라도 위와 같은 실수를 할 수 있기 때문에  본인 나름의 **규칙을 정하면 실수를 줄일 수 있다**.

 ✅ 실수를 방지하는 팁
- **항상 큰 숫자를 오른편에 배치한다.**
- **항상 작은 숫자를 왼편에 배치한다.**

이러한 코딩 스타일을 유지하면 헷갈리지 않고 실수를 방지할 수 있다.




---
[개발노트로 돌아가기](../개발노트.md)